<html>
  <head>
    <meta http-equiv="Content-Type" content="text/html;charset=UTF-8" />
    <!-- vue所需的依赖 -->
    <script src="https://cdn.jsdelivr.net/npm/vue/dist/vue.js"></script>
    <!-- 引入elementUI样式 -->
    <link
      rel="stylesheet"
      href="https://unpkg.com/element-ui/lib/theme-chalk/index.css"
    />
    <!-- 引入elementUI组件库 -->
    <script src="https://unpkg.com/element-ui/lib/index.js"></script>
    <!-- 引入jQuery所需依赖-->
    <script src="https://cdn.staticfile.org/jquery/1.10.2/jquery.min.js"></script>
    <!--<script src="http://pv.sohu.com/cityjson?ie=utf-8"></script>-->
  </head>

  <body>
    <div id="app">
      <!-- 注销按钮 -->
      <el-button id="logoutBtn" type="info" @click="logoutCAS(loginFlag)">
        注销
      </el-button>
      <!-- 具体应用的显示窗口 -->
      <div id="frameDiv" class="frameContent">
        <iframe
          id="subPage"
          frameborder="no"
          border="0"
          marginwidth="0"
          marginheight="0"
          style="width: 100%"
        ></iframe>
        <!-- <iframe id="subPage" frameborder="no" border="0" marginwidth="0" marginheight="0" style="width:100%" src = "subpage/SelectPage/Navigation.html?signature=534f92288cd2332140ee4281&userId=534bbbe18cd23317f008f0b8&account=zhang&domain=cloud.vsso.ac.cn&permission=10010#0011100#11001011&name=张明浩" ></iframe> -->
      </div>
    </div>
  </body>

  <style>
    #logoutBtn {
      top: 1vh;
      left: 1vw;
      position: absolute;
    }

    .content {
      width: 1170px;
      height: 100px;
      background-color: #c3c3c3;
      margin: 0 auto;
    }

    .frameContent {
      width: 1170px;
      margin: 0 auto;
    }
  </style>
  <script type="text/javascript">
    var app = new Vue({
      el: "#app",
      data: {
        logged: false,
        loginFlag: "CAS",
        CASUsername: "",
        ticket: "",
      },
      created() {
        let params = this.getLocationParams();
        if (JSON.stringify(params) !== "{}") {
          this.logged = true;
          this.CASUsername = params.CURRENTCASUSER;
          this.ticket = params.ticket;
        }
      },
      mounted() {
        // if (!this.logged) {
        //   this.requestLogin();
        // }
      },
      methods: {
        requestLogin() {
          Vue.prototype
            .$confirm("请在登录后使用本系统", "提示", {
              showClose: false,
              closeOnClickModal: false,
              confirmButtonText: "前往统一认证",
              cancelButtonText: "返回研究网络",
              type: "warning",
            })
            .then(() => {
              // 进行统一认证
              this.loginCAS();
            })
            .catch(() => {
              // 返回研究网络
              this.goStarNet();
            });
        },
        checkLogin() {
          if (!this.logged) {
            this.requestLogin();
          }
        },
        goStarNet() {
          // window.history.back();
          window.location.href = "http://starnet.cssdc.ac.cn/";
        },
        loginCAS() {
          window.location.href =
            "https://umt.nssdc.ac.cn/login?service=http://localhost/AppPlat/index.html";
        },
        /**
         * 注销cas
         * @param url 客户端的注销回调函数 http://xxxxxx
         * @param loginFlag 客户端通过接口获取的登录标识 loginFlag
         */
        logoutCAS(loginFlag) {
          console.log(loginFlag);
          url = "http://localhost/AppPlat/index.html";
          jQuery.ajax({
            url:
              "https://umt.nssdc.ac.cn/logoutClient.do?loginFlag=" + loginFlag,
            async: true,
            type: "get",
            dataType: "JSONP",
            jsonp: "callback",
            jsonpCallback: "jsonpCallback",
            success: function (data) {
              if (data && data != "") {
                //第三方登录进来
                window.top.location.href = data + url; //注销：第三方、cas、客户端
              } else {
                //非第三方登录进来
                window.top.location.href =
                  "https://umt.nssdc.ac.cn/logout?service=" + url; //注销：cas、客户端
              }
            },
          });
        },
        getLocationParams() {
          // author: https://www.cnblogs.com/callmelx/p/10654284.html
          var url = decodeURI(location.search); //获取url中"?"符后的字串
          var theRequest = new Object();
          if (url.indexOf("?") != -1) {
            var str = url.substr(1);
            strs = str.split("&");
            for (var i = 0; i < strs.length; i++) {
              theRequest[strs[i].split("=")[0]] = unescape(
                strs[i].split("=")[1]
              );
            }
          }
          return theRequest;
        },
      },
    });
  </script>
  <script type="text/javascript">
    var frameHeight = 0;
    //        document.write(returnCitySN["cip"]+','+returnCitySN["cname"])
    window.onload = function () {
      //加随机数，模拟用户的随机登陆
      //            var src = "subpage/SelectPage/Navigation.html?signature=534f92288cd2332140ee4281&userId=";
      //            src += randomString(24);
      //            src += "&account=zhang&domain=cloud.vsso.ac.cn&permission=10010#0011100#11001011&name=张明浩";
      var src1 =
        "subpage/SelectPage/Navigation.html?signature=534f92288cd2332140ee4281&userId=111bbbe18cd23317f008f111&account=nie&domain=cloud.vsso.ac.cn&permission=10010#0011100#11001011&name=聂殿辉";
      var src3 =
        "subpage/SelectPage/Navigation.html?signature=534f92288cd2332140ee4281&userId=333bbbe18cd23317f008f333&account=du&domain=cloud.vsso.ac.cn&permission=10010#0011100#11001011&name=杜鹏宇";
      var src4 =
        "subpage/SelectPage/Navigation.html?signature=534f92288cd2332140ee4281&userId=534bbbe18cd23317f008f0b8&account=zhang&domain=cloud.vsso.ac.cn&permission=10010#0011100#11001011&name=张明浩";
      var randomNumber = Math.random();
      if (randomNumber >= 0 && randomNumber < 0.3) {
        document.getElementById("subPage").src = src1;
      }
      //            else if(randomNumber >= 0.25 && randomNumber < 0.5){
      //                document.getElementById('subPage').src = src2;
      //            }
      else if (randomNumber >= 0.3 && randomNumber < 0.6) {
        document.getElementById("subPage").src = src3;
      } else if (randomNumber >= 0.6 && randomNumber <= 1) {
        document.getElementById("subPage").src = src4;
      }
      console.log(document.getElementById("subPage").src);
    };
    //        randomString = function (len) {
    //                    len = len || 24;
    //                    var $chars = 'ABCDEFGHJKMNPQRSTWXYZabcdefhijkmnprstwxyz2345678';
    //                    /****默认去掉了容易混淆的字符oOLl,9gq,Vv,Uu,I1****/
    //                    var maxPos = $chars.length;
    //                    var pwd = '';
    //                    for (i = 0; i < len; i++) {
    //                        pwd += $chars.charAt(Math.floor(Math.random() * maxPos));
    //                    }
    //                    return pwd;
    //                }
    window.addEventListener("message", getMessage, false);
    function getMessage(event) {
      // 这里注意vue也会发出一个message，但是data已经是json的形式，因此需要提前判断
      windowMsg = event.data;
      if (typeof windowMsg !== "string" || windowMsg.constructor !== String) {
        console.log("非内部信息");
        return;
      }
      var data = JSON.parse(event.data);
      console.log(data);
      if (data.command == "height") {
        frameHeight = data.value + "px";
        document.getElementById("subPage").style.height = frameHeight;
      } else if (data.command == "max") {
        var div = document.getElementById("frameDiv");
        div.style.position = "absolute";
        div.style.top = 0;
        div.style.left = 0;
        div.style.zIndex = 999;
        div.style.width = window.screen.availWidth;
        div.style.height = window.screen.availHeight;
      } else if (data.command == "restore") {
        var div = document.getElementById("frameDiv");
        div.style.position = "relative";
        div.style.width = "1170px";
        div.style.height = frameHeight;
      } else {
        console.log(data);

        alert(data);
      }
    }
  </script>
</html>
